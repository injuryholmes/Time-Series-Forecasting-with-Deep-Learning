import torch
from torch import nn
from torch.autograd import Variable
from torch.utils.data import DataLoader
from torch import optim
from torch.optim import lr_scheduler
from torch.utils.tensorboard import SummaryWriter
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import matplotlib.dates as mdates
from matplotlib.dates import MonthLocator, DateFormatter
# Local imports
from utils.data_sp500_delta_lookahead import SP500
from TCN.model_bn_tri import TCN
from torch import autograd
from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score
from math import sqrt
import config.stock_config as cfg
import pandas as pd
from IPython import embed
import time

sp500_stl_sudden_change_loss = [268.96, 444.86, 572.09, 741.06, 863.97, 959.23, 1055.15, 1144.36, 1245.15, 1360.22, 1485.37, 1561.91, 1705.06, 1820.15, 1944.13, 2052.9, 2194.53, 2286.66, 2372.06, 2464.53, 2556.79, 2642.41, 2729.03, 2782.77, 2844.87, 2959.39, 3044.09, 3154.18, 3203.35, 3280.77, 3350.02, 3419.46, 3479.73, 3550.65, 3606.99, 3688.0, 3748.14, 3785.68, 3844.78, 3892.94, 3929.75, 3978.7, 4010.04, 4059.23, 4103.0, 4180.35, 4228.62, 4279.37, 4331.92, 4388.66, 4444.69, 4495.57, 4544.44, 4605.37, 4700.76, 4744.15, 4789.8, 4816.64, 4868.18, 4900.4, 4935.78, 4993.89, 5049.96, 5084.74, 5123.75, 5156.8, 5193.42, 5249.64, 5275.46, 5310.81, 5329.75, 5374.88, 5423.52, 5453.39, 5490.5, 5559.31, 5615.9, 5648.51, 5664.91, 5717.32, 5760.33, 5782.89, 5833.62, 5859.21, 5886.17, 5933.13, 5962.33, 5990.08, 6029.84, 6058.05, 6105.79, 6147.39, 6199.21, 6237.56, 6302.37, 6361.32, 6396.04, 6445.99, 6470.86, 6501.59, 6524.1, 6575.55, 6600.06, 6661.08, 6705.4, 6728.37, 6752.33, 6804.15, 6826.02, 6860.64, 6896.72, 6918.36, 6937.4, 6978.05, 7006.08, 7044.02, 7084.01, 7117.7, 7156.14, 7213.5, 7240.26, 7311.26, 7324.19, 7356.53, 7404.41, 7431.36, 7491.35, 7514.47, 7553.31, 7580.55, 7610.69, 7626.23, 7647.47, 7687.52, 7708.77, 7730.79, 7772.96, 7842.99, 7883.11, 7922.71, 7993.18, 8051.46, 8082.75, 8102.43, 8114.59, 8130.92, 8181.91, 8208.19, 8255.08, 8304.46, 8331.55, 8373.4, 8403.65, 8431.76, 8447.28, 8463.94, 8514.39, 8552.85, 8603.76]
sp500_stl_rest_loss = [8541.56, 8365.66, 8238.43, 8069.46, 7946.55, 7851.29, 7755.37, 7666.16, 7565.37, 7450.3, 7325.15, 7248.61, 7105.46, 6990.37, 6866.39, 6757.62, 6615.99, 6523.86, 6438.46, 6345.99, 6253.73, 6168.11, 6081.49, 6027.75, 5965.65, 5851.13, 5766.43, 5656.34, 5607.17, 5529.75, 5460.5, 5391.06, 5330.79, 5259.87, 5203.53, 5122.52, 5062.38, 5024.84, 4965.74, 4917.58, 4880.77, 4831.82, 4800.48, 4751.29, 4707.52, 4630.17, 4581.9, 4531.15, 4478.6, 4421.86, 4365.83, 4314.95, 4266.08, 4205.15, 4109.76, 4066.37, 4020.72, 3993.88, 3942.34, 3910.12, 3874.74, 3816.63, 3760.56, 3725.78, 3686.77, 3653.72, 3617.1, 3560.88, 3535.06, 3499.71, 3480.77, 3435.64, 3387.0, 3357.13, 3320.02, 3251.21, 3194.62, 3162.01, 3145.61, 3093.2, 3050.19, 3027.63, 2976.9, 2951.31, 2924.35, 2877.39, 2848.19, 2820.44, 2780.68, 2752.47, 2704.73, 2663.13, 2611.31, 2572.96, 2508.15, 2449.2, 2414.48, 2364.53, 2339.66, 2308.93, 2286.42, 2234.97, 2210.46, 2149.44, 2105.12, 2082.15, 2058.19, 2006.37, 1984.5, 1949.88, 1913.8, 1892.16, 1873.12, 1832.47, 1804.44, 1766.5, 1726.51, 1692.82, 1654.38, 1597.02, 1570.26, 1499.26, 1486.33, 1453.99, 1406.11, 1379.16, 1319.17, 1296.05, 1257.21, 1229.97, 1199.83, 1184.29, 1163.05, 1123.0, 1101.75, 1079.73, 1037.56, 967.53, 927.41, 887.81, 817.34, 759.06, 727.77, 708.09, 695.93, 679.6, 628.61, 602.33, 555.44, 506.06, 478.97, 437.12, 406.87, 378.76, 363.24, 346.58, 296.13, 257.67, 206.76]
sp500_stl_all_rmse = [5.36, 11.11, 9.35, 3.46, 2.07, 9.27, 2.23, 7.84, 16.94, 1.85, 6.86, 4.69, 1.08, 14.69, 5.19, 24.53, 4.31, 8.73, 12.97, 9.36, 13.96, 16.94, 15.59, 3.54, 22.82, 2.14, 2.58, 8.15, 9.89, 4.82, 2.33, 29.5, 17.92, 5.2, 15.8, 37.53, 9.95, 1.8, 4.55, 11.95, 5.78, 7.24, 5.29, 3.33, 15.65, 15.62, 0.23, 1.18, 9.39, 0.13, 9.28, 9.41, 10.48, 3.05, 0.35, 5.47, 11.88, 1.61, 5.74, 17.13, 3.9, 11.57, 10.18, 10.15, 2.33, 6.64, 6.67, 1.19, 8.43, 1.98, 1.13, 5.84, 9.26, 11.4, 3.66, 3.78, 4.27, 1.56, 12.98, 0.79, 6.24, 7.85, 13.1, 2.6, 0.87, 1.19, 10.42, 10.74, 3.28, 5.7, 0.25, 5.67, 1.66, 7.94, 4.58, 7.89, 1.03, 12.64, 4.66, 3.37, 5.07, 1.82, 18.51, 7.59, 2.4, 6.37, 4.58, 2.75, 2.39, 2.4, 16.63, 11.86, 20.36, 3.45, 5.2, 9.59, 11.93, 23.86, 13.65, 5.0, 1.83, 6.69, 5.39, 9.98, 4.47, 4.07, 10.76, 6.34, 3.86, 1.24, 2.84, 1.68, 5.87, 1.49, 5.03, 6.86, 8.66, 7.49, 4.81, 9.32, 6.11, 12.51, 6.58, 8.59, 23.04, 3.56, 5.2, 5.56, 10.86, 6.19, 12.09, 29.84, 15.21, 9.9, 3.11, 27.33, 0.9, 9.4, 9.02, 18.9, 31.28, 36.41, 13.91, 30.36, 13.57, 1.97, 25.46, 16.04, 25.51, 26.05, 9.05, 15.13, 7.01, 5.86, 16.38, 2.51, 25.72, 3.98, 2.07, 6.59, 1.4, 7.33, 1.84, 5.72, 1.29, 5.36, 1.24, 2.78, 7.34, 10.92, 0.0, 14.14, 3.5, 0.12, 5.16, 3.97, 13.3, 7.88, 12.52, 1.95, 0.06, 0.89, 14.04, 11.75, 27.55, 6.78, 14.26, 21.77, 11.51, 37.92, 26.35, 19.16, 21.51, 3.73, 5.13, 2.91, 4.15, 0.68, 28.99, 4.68, 21.17, 27.52, 0.11, 14.76, 14.45, 14.93, 25.98, 7.2, 27.27, 20.1, 5.22, 18.16, 26.2, 6.42, 14.36, 4.7, 38.96, 0.82, 18.28, 18.74, 16.24, 0.61, 17.35, 7.09, 0.88, 10.1, 0.31, 18.33, 8.49, 6.81, 4.12, 0.24, 10.97, 0.39, 8.99, 0.98, 3.73, 7.62, 8.28, 3.68, 7.44, 0.45, 29.15, 1.69, 21.91, 7.24, 20.55, 8.45, 21.91, 5.71, 33.75, 5.98, 14.43, 4.39, 9.28, 38.73, 4.74, 8.93, 13.76, 10.95, 2.05, 4.57, 21.8, 1.57, 2.13, 10.68, 10.91, 7.91, 4.06, 0.77, 0.02, 13.45, 6.8, 18.47, 9.67, 6.87, 6.33, 13.99, 6.67, 3.23, 15.57, 10.94, 6.43, 16.79, 16.9, 6.31, 11.4, 7.23, 7.23, 1.89, 12.36, 0.32, 14.0, 1.13, 2.57, 5.53, 3.02, 19.47, 13.83, 0.81, 10.3, 3.35, 2.02, 0.98, 12.98, 0.5, 11.79, 0.12, 18.62, 2.74, 8.11, 0.04, 12.15, 1.01, 17.3, 9.82, 4.33, 3.65, 12.2, 13.26, 5.61, 31.45, 11.07, 13.35, 3.48, 4.48, 10.5, 22.95, 6.1, 11.41, 13.98, 13.13, 2.01, 7.03, 6.5, 2.72, 6.34, 1.96, 12.17, 24.52, 10.09, 7.12, 8.27, 9.18, 12.24, 11.99, 3.33, 3.34, 21.84, 2.84, 8.68, 16.28, 16.11, 0.68, 7.05, 18.02, 1.43, 14.79, 34.77, 64.94, 71.25, 58.27, 28.79, 38.97, 17.7, 3.94, 53.21, 17.21, 14.72, 14.89, 27.21, 39.04, 20.37, 14.12, 12.27, 15.05, 16.2, 1.71, 29.33, 5.74, 2.79, 2.44, 3.35, 13.37, 44.73, 0.06, 16.93, 7.18, 39.3, 30.98, 1.04, 12.16, 22.69, 4.25, 1.27, 5.67, 9.13, 16.02, 7.78, 8.36, 0.54, 21.59, 19.95, 1.76, 0.55, 8.43, 23.11, 6.67, 8.45, 16.12, 9.11, 6.53, 2.07, 5.71, 10.65, 5.28, 15.67, 21.71, 20.19, 30.08, 4.3, 28.73, 0.8, 6.04, 4.6, 11.31, 0.83, 0.84, 13.51, 12.14, 21.64, 31.53, 27.9, 10.71, 1.81, 7.03, 3.82, 23.12, 3.13, 0.62, 22.56, 28.24, 27.89, 12.52, 1.26, 17.25, 1.74, 10.08, 8.53, 11.56, 5.7, 10.45, 7.24, 11.48, 28.18, 43.87, 29.83, 9.43, 57.03, 24.66, 19.76, 25.33, 7.18, 5.71, 3.64, 25.68, 27.59, 17.71, 3.52, 39.49, 13.39, 18.43, 12.11, 4.15, 23.61, 7.1, 15.71, 25.83, 10.36, 19.17, 2.93, 30.82, 5.38, 9.07, 5.28, 15.2, 28.61, 14.23, 10.03, 10.4, 26.68, 12.8, 18.59, 7.76, 13.32, 2.98, 5.78, 11.88, 17.61, 6.29, 17.44, 18.46, 15.77, 11.26, 8.28, 9.6, 7.1, 10.92, 5.51, 20.57, 0.77, 2.56, 26.67, 5.19, 11.33, 19.39, 12.61, 6.49, 23.54, 10.65, 5.14, 2.39, 0.06, 20.57, 2.06, 0.49, 10.1, 0.69, 4.83, 2.69, 1.21, 4.76, 5.28, 1.0, 4.36, 2.44, 15.88, 15.06, 3.1, 11.83, 16.65, 7.19, 13.61, 21.07, 13.61, 10.01, 6.75, 2.83, 4.08, 14.83, 4.53, 1.37, 10.49, 6.23, 12.07, 15.04, 0.86, 2.63, 1.88, 5.78, 7.53, 2.81, 2.05, 0.41, 18.18, 20.97, 1.72, 6.74, 4.59, 6.36, 6.99, 46.28, 12.06, 6.83, 1.81, 29.86, 8.85, 11.63, 32.29, 4.06, 2.77, 1.7, 11.41, 3.97, 4.12, 9.59, 5.0, 9.04, 3.48, 7.86, 4.63, 2.77, 0.1, 7.34, 4.49, 9.29, 0.32, 11.48, 6.15, 1.83, 5.21, 4.41, 1.77, 12.3, 0.12, 4.76, 1.01, 1.31, 8.29, 4.71, 5.72, 9.14, 13.48, 8.32, 10.04, 15.74, 3.04, 1.81, 5.11, 1.23, 13.78, 2.21, 5.12, 8.18, 12.5, 53.95, 5.36, 13.19, 16.5, 5.28, 15.33, 25.2, 1.78, 13.08, 2.71, 11.39, 11.62, 2.55, 12.52, 1.35, 5.15, 13.32, 12.29, 3.72, 17.81, 13.18, 22.34, 2.28, 24.32, 16.17, 13.0, 24.02, 6.47, 7.73, 8.35, 12.62, 5.95, 24.62, 21.8, 9.97, 16.3, 26.95, 4.86, 11.0, 12.02, 2.18, 13.45, 64.53, 5.75, 10.72, 1.21, 1.26, 5.26, 8.41, 4.28, 3.15, 8.73, 18.08, 8.16, 1.78, 9.07, 8.45, 14.53, 0.99, 15.25, 4.22, 35.81, 8.78, 4.37, 0.71, 2.6, 9.35, 12.91, 25.19, 2.51, 8.72, 5.62, 7.51, 6.57, 4.89, 24.8, 0.12, 24.95, 20.09, 8.77, 10.29, 3.11, 1.51, 0.01, 5.55, 9.31, 1.37, 8.15, 4.39, 8.96, 10.82, 4.0, 6.67, 11.36, 0.9, 10.43, 13.85, 30.11, 28.22, 6.56, 7.15, 3.02, 8.33, 11.25, 7.53, 6.85, 4.9, 16.03, 24.05, 1.54, 16.41, 4.34, 10.02, 9.69, 24.83, 19.38, 5.52, 14.71, 12.35, 16.44, 20.06, 15.49, 19.45, 6.33, 16.72, 1.5, 15.96, 4.94, 13.85, 10.88, 5.98, 49.58, 4.14, 12.51, 15.59, 41.49, 39.05, 11.54, 9.35, 4.61, 0.23, 13.55, 25.86, 5.25, 2.99, 3.72, 6.54, 0.0, 8.14, 4.18, 14.12, 12.34, 6.07, 5.47, 31.29, 19.63, 0.2, 7.61, 20.85, 13.63, 12.82, 14.25, 0.54, 4.05, 3.8, 10.24, 1.66, 13.53, 7.69, 2.88, 11.17, 11.68, 25.31, 17.22, 5.42, 6.31, 5.9, 6.13, 1.48, 15.33, 8.22]

sh_stl_all_rmse =  [84.57, 42.25, 5.71, 40.13, 65.48, 23.92, 10.04, 57.8, 1.35, 39.37, 77.78, 1.37, 51.96, 59.16, 3.73, 50.64, 89.66, 30.59, 60.8, 76.65, 8.58, 25.9, 5.85, 17.32, 107.33, 28.1, 67.03, 29.7, 183.4, 11.72, 21.37, 37.31, 40.14, 14.65, 8.07, 59.85, 15.98, 48.78, 30.58, 123.26, 75.17, 0.74, 61.97, 9.7, 12.92, 14.34, 12.05, 9.96, 33.55, 74.08, 15.12, 8.45, 46.79, 2.33, 3.89, 11.61, 81.69, 1.51, 3.41, 34.44, 4.54, 46.55, 24.67, 56.67, 4.07, 23.0, 46.73, 7.38, 14.23, 35.43, 8.45, 71.42, 79.83, 43.05, 10.34, 73.74, 66.18, 5.83, 62.73, 80.5, 51.09, 2.66, 56.92, 135.14, 42.46, 101.28, 53.4, 89.63, 11.86, 54.6, 94.76, 44.67, 39.96, 40.62, 37.35, 179.72, 111.68, 106.52, 41.31, 87.64, 49.47, 31.18, 2.58, 56.49, 2.19, 131.14, 6.72, 58.48, 72.1, 146.95, 37.85, 15.45, 331.61, 64.1, 160.69, 56.19, 31.19, 25.32, 10.97, 62.48, 46.38, 69.26, 14.01, 21.39, 119.73, 125.24, 44.38, 120.18, 222.28, 47.31, 110.01, 202.5, 209.75, 252.26, 250.58, 135.71, 167.5, 107.56, 163.26, 96.3, 17.99, 254.73, 237.16, 30.06, 30.37, 67.29, 46.77, 146.89, 54.88, 97.68, 32.1, 111.21, 53.06, 251.33, 30.4, 128.95, 30.81, 16.36, 4.22, 140.05, 35.52, 50.79, 62.41, 136.29, 5.53, 28.48, 76.73, 8.15, 59.41, 254.06, 127.93, 67.91, 85.91, 183.46, 85.28, 51.73, 101.94, 92.06, 15.39, 21.37, 118.45, 69.17, 144.79, 66.63, 31.86, 9.55, 103.82, 43.79, 130.35, 14.14, 23.78, 94.19, 21.38, 5.19, 13.06, 20.91, 5.59, 15.61, 0.47, 6.0, 13.78, 73.03, 42.31, 7.52, 86.94, 32.92, 27.1, 50.94, 110.33, 71.31, 39.09, 27.76, 34.39, 44.95, 2.85, 7.88, 16.97, 16.21, 132.1, 62.39, 80.52, 58.72, 36.83, 19.02, 24.61, 18.13, 70.94, 15.75, 31.92, 32.5, 8.29, 23.5, 13.17, 35.18, 25.58, 172.83, 26.66, 14.42, 89.11, 64.21, 19.33, 0.46, 37.6, 4.71, 6.58, 5.68, 113.32, 1.8, 18.47, 41.92, 3.91, 80.09, 3.95, 21.0, 19.86, 7.98, 105.01, 12.77, 0.96, 30.11, 247.85, 55.43, 82.29, 156.0, 21.5, 87.44, 30.12, 98.36, 125.1, 77.91, 83.55, 108.2, 0.69, 43.35, 6.22, 6.8, 153.56, 48.94, 46.07, 69.61, 24.77, 54.06, 28.85, 24.4, 17.5, 58.8, 79.58, 55.08, 31.1, 10.58, 38.6, 22.69, 43.24, 176.66, 17.28, 68.55, 30.02, 123.65, 12.12, 33.92, 10.65, 7.08, 20.09, 50.95, 35.68, 33.09, 16.69, 14.06, 28.05, 36.15, 33.24, 5.63, 21.45, 22.76, 17.43, 29.14, 41.85, 52.69, 10.43, 15.34, 52.37, 15.36, 55.79, 3.0, 24.76, 3.33, 17.51, 4.22, 13.88, 24.6, 6.04, 84.67, 18.16, 24.74, 0.26, 22.79, 13.83, 15.19, 2.48, 50.58, 13.7, 14.19, 85.08, 79.86, 15.21, 10.09, 28.49, 4.08, 39.55, 6.28, 13.84, 2.98, 37.7, 16.78, 13.74, 23.75, 1.41, 2.42, 9.47, 93.92, 4.97, 13.08, 7.18, 10.27, 4.39, 4.82, 66.17, 0.83, 85.34, 2.91, 12.88, 0.67, 23.23, 31.5, 8.86, 24.21, 50.3, 35.45, 9.04, 1.69, 3.07, 66.4, 11.73, 24.34, 9.9, 9.63, 0.1, 61.12, 9.12, 2.65, 4.62, 1.34, 5.39, 6.05, 9.83, 24.61, 4.96, 36.51, 58.96, 9.99, 13.16, 15.64, 15.46, 20.51, 7.18, 0.83, 32.75, 26.09, 3.94, 7.68, 47.85, 65.99, 25.69, 0.6, 5.81, 9.02, 22.14, 5.76, 8.81, 2.69, 2.3, 4.59, 1.47, 13.67, 20.36, 9.91, 0.55, 20.65, 1.23, 6.78, 16.69, 17.37, 6.47, 6.16, 18.21, 1.9, 4.08, 2.88, 15.57, 48.42, 9.88, 12.19, 0.62, 11.49, 26.83, 9.38, 4.9, 2.3, 9.47, 24.46, 44.47, 1.36, 2.99, 10.2, 35.02, 3.23, 12.84, 1.38, 8.48, 4.7, 19.65, 9.49, 33.84, 2.51, 7.71, 5.66, 17.25, 19.57, 26.7, 25.61, 3.17, 5.37, 11.52, 14.36, 31.01, 25.9, 8.15, 6.22, 20.51, 5.49, 18.13, 20.96, 13.97, 20.87, 1.57, 7.79, 32.53, 12.35, 27.1, 81.36, 3.53, 6.88, 5.54, 9.59, 1.86, 11.39, 27.16, 11.18, 21.57, 26.17, 1.71, 9.68, 0.91, 4.44, 29.93, 25.19, 6.73, 8.92, 23.98, 3.7, 16.51, 18.98, 6.73, 0.01, 20.99, 9.47, 1.23, 27.74, 11.19, 9.04, 14.07, 9.68, 21.19, 8.58, 0.21, 21.29, 19.61, 13.19, 14.68, 0.94, 1.27, 19.69, 24.39, 37.98, 11.08, 7.32, 6.63, 7.72, 18.83, 12.61, 9.75, 23.6, 0.21, 13.09, 11.31, 0.65, 14.81, 5.33, 29.25, 5.15, 9.01, 20.65, 37.46, 0.03, 7.84, 1.34, 0.11, 25.33, 2.58, 12.63, 15.32, 25.47, 8.62, 33.4, 5.87, 4.19, 16.13, 21.1, 6.93, 13.99, 30.5, 7.29, 22.18, 13.24, 3.49, 7.1, 32.42, 1.33, 11.74, 23.99, 12.09, 0.22, 1.49, 1.44, 11.72, 12.88, 15.81, 21.89, 26.76, 32.75, 3.37, 35.57, 2.14, 11.75, 2.12, 6.84, 7.09, 15.69, 53.84, 13.02, 15.16]
sh_sudden_change_loss =[796.86, 1908.15, 2719.15, 3467.66, 4170.46, 4928.99, 5464.12, 6150.05, 6589.17, 7145.58, 7617.6, 7962.69, 8314.35, 8764.49, 9092.24, 9511.7, 10004.2, 10380.17, 10654.2, 10918.96, 11135.67, 11364.75, 11740.81, 12031.1, 12384.06, 12602.57, 12818.21, 13092.69, 13266.72, 13452.82, 13757.69, 13975.72, 14204.89, 14446.27, 14622.04, 14786.33, 14955.12, 15146.71, 15320.97, 15568.42, 15787.38, 15966.24, 16111.11, 16318.24, 16465.25, 16540.48, 16664.29, 16823.92, 17048.16, 17160.21, 17276.58, 17362.78, 17456.01, 17546.5, 17632.56, 17730.02, 17887.62, 18048.97, 18140.72, 18272.58, 18346.9, 18501.7, 18616.42, 18682.35, 18757.98, 18874.27, 18962.37, 19041.6, 19148.81, 19273.53, 19352.03, 19388.8, 19460.17, 19554.37, 19592.6, 19776.91, 19842.61, 19872.88, 19944.76, 20024.55, 20077.48, 20143.99, 20241.66, 20287.26, 20331.49, 20419.61, 20458.25, 20476.44, 20544.26, 20608.32, 20682.32, 20727.0, 20757.23, 20827.91, 20867.24, 20917.09, 20967.16, 21171.06, 21229.66]
sh_stl_rest_loss = [21599.13, 20487.84, 19676.84, 18928.33, 18225.53, 17467.0, 16931.87, 16245.94, 15806.82, 15250.41, 14778.39, 14433.3, 14081.64, 13631.5, 13303.75, 12884.29, 12391.79, 12015.82, 11741.79, 11477.03, 11260.32, 11031.24, 10655.18, 10364.89, 10011.93, 9793.42, 9577.78, 9303.3, 9129.27, 8943.17, 8638.3, 8420.27, 8191.1, 7949.72, 7773.95, 7609.66, 7440.87, 7249.28, 7075.02, 6827.57, 6608.61, 6429.75, 6284.88, 6077.75, 5930.74, 5855.51, 5731.7, 5572.07, 5347.83, 5235.78, 5119.41, 5033.21, 4939.98, 4849.49, 4763.43, 4665.97, 4508.37, 4347.02, 4255.27, 4123.41, 4049.09, 3894.29, 3779.57, 3713.64, 3638.01, 3521.72, 3433.62, 3354.39, 3247.18, 3122.46, 3043.96, 3007.19, 2935.82, 2841.62, 2803.39, 2619.08, 2553.38, 2523.11, 2451.23, 2371.44, 2318.51, 2252.0, 2154.33, 2108.73, 2064.5, 1976.38, 1937.74, 1919.55, 1851.73, 1787.67, 1713.67, 1668.99, 1638.76, 1568.08, 1528.75, 1478.9, 1428.83, 1224.93, 1166.33]

def analysis(symbol,mtl_all_rmse,mtl_sudden_change_loss,mtl_rest_loss):
    if symbol == '^GSPC':
        stl_all_rmse = sp500_stl_all_rmse
        stl_sudden_change_loss = sp500_stl_sudden_change_loss
        stl_rest_loss = sp500_stl_rest_loss
        topK = 800
        totalNum = 826
    elif symbol == '^shanghai':
        stl_all_rmse = sh_stl_all_rmse
        stl_sudden_change_loss = sh_sudden_change_loss
        stl_rest_loss = sh_stl_rest_loss
        topK = 500
        totalNum = 601

    ans = [mtl_all_rmse[i]-stl_all_rmse[i] for i in range(len(stl_all_rmse))]
    mtl_win = sum([1 for ele in ans if ele <= 0])
    print("MTL perform better ratio: " + str(mtl_win/len(stl_all_rmse)))

    lst = list(range(topK))
    ss = lst[5::5]

    mtl_total = [sum(x) for x in zip(mtl_sudden_change_loss, mtl_rest_loss)]
    stl_total = [sum(x) for x in zip(stl_sudden_change_loss, stl_rest_loss)]

    mtl_sudden_change_loss = [mtl_sudden_change_loss[i]/ss[i] for i in range(len(ss))]
    mtl_rest_loss = [mtl_rest_loss[i]/(totalNum-ss[i]) for i in range(len(ss))]

    stl_sudden_change_loss = [stl_sudden_change_loss[i]/ss[i] for i in range(len(ss))]
    stl_rest_loss = [stl_rest_loss[i]/(totalNum-ss[i]) for i in range(len(ss))]

    # breakpoint()
    fig,ax = plt.subplots()
    # ax.plot(np.array(ss)[:10], mtl_sudden_change_loss[:10], color="red", linestyle='dashed',label="MTL sudden")
    # ax.plot(np.array(ss)[:10], stl_sudden_change_loss[:10], color="red", label="STL sudden")
    ax.plot(np.array(ss)[-10:], mtl_sudden_change_loss[-10:], color="red", linestyle='dashed',label="MTL sudden")
    ax.plot(np.array(ss)[-10:], stl_sudden_change_loss[-10:], color="red", label="STL sudden")
    plt.legend(loc=3)
    ax.set_xlabel("size",fontsize=12)
    ax.set_ylabel("Avg MSE loss for sudden change points",color="red",fontsize=12)
    ax2=ax.twinx()
    # ax2.plot(np.array(ss)[:10], mtl_rest_loss[:10],color="blue", linestyle='dashed', label="MTL rest")
    # ax2.plot(np.array(ss)[:10], stl_rest_loss[:10],color="blue", label="STL rest")
    ax2.plot(np.array(ss)[-10:], mtl_rest_loss[-10:],color="blue", linestyle='dashed', label="MTL rest")
    ax2.plot(np.array(ss)[-10:], stl_rest_loss[-10:],color="blue", label="STL rest")
    ax2.set_ylabel("Avg MSE loss for the rest of the points",color="blue",fontsize=12)
    plt.legend(loc=1)
    plt.savefig("MTL loss comparison.png")
    plt.show()


    h = plt.figure()

    plt.plot(ss, mtl_total, label="MTL total loss")
    plt.plot(ss, stl_total, label="STL total loss")
    
    plt.xlabel("size")
    plt.ylabel("total loss")
    plt.legend()
    plt.savefig('multiclass test loss.png')
    plt.show()

    


