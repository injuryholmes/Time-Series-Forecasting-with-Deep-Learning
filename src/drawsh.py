import torch
from torch import nn
from torch.autograd import Variable
from torch.utils.data import DataLoader
from torch import optim
from torch.optim import lr_scheduler
from torch.utils.tensorboard import SummaryWriter
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import matplotlib.dates as mdates
from matplotlib.dates import MonthLocator, DateFormatter
# Local imports
from utils.data_sp500_delta_lookahead import SP500
from TCN.model_bn_tri import TCN
from torch import autograd
from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score
from math import sqrt
import config.stock_config as cfg
import pandas as pd
from IPython import embed
import time


# mtl_sudden_change_loss = [588.9561767578125, 1017.7818603515625, 1388.791748046875, 1726.3226318359375, 2046.4058837890625, 2357.881103515625, 2645.627197265625, 2930.4398193359375, 3197.06298828125, 3448.1934814453125, 3689.318115234375, 3917.808349609375, 4144.365478515625, 4361.03955078125]
# mtl_rest_loss = [8735.675659179688, 8306.849975585938, 7935.840087890625, 7598.3092041015625, 7278.2259521484375, 6966.750732421875, 6679.004638671875, 6394.1920166015625, 6127.56884765625, 5876.4383544921875, 5635.313720703125, 5406.823486328125, 5180.266357421875, 4963.59228515625]

# stl_sudden_change_loss = [436.5263671875, 725.27880859375, 942.2083740234375, 1136.896728515625, 1321.39501953125, 1559.709228515625, 1801.1455078125, 2003.159423828125, 2223.577880859375, 2431.6689453125, 2610.11865234375, 2778.9383544921875, 2963.124755859375, 3121.673095703125]
 
# stl_rest_loss = [8749.202270507812, 8460.449829101562, 8243.520263671875, 8048.8319091796875, 7864.3336181640625, 7626.0194091796875, 7384.5831298828125, 7182.5692138671875, 6962.1507568359375, 6754.0596923828125, 6575.6099853515625, 6406.790283203125, 6222.6038818359375, 6064.0555419921875]
# ss = [5,10,15,20,25,30,35,40,45,50,55,60,65,70]

lst = list(range(500))
ss = lst[5::5]
num = 600
# binary task LBW = 2; loss = loss1**loss2
stl_sudden_change_loss= [826.11083984375, 1945.9765625, 2776.008544921875, 3567.80810546875, 4269.2255859375, 5034.665771484375, 5580.99755859375, 6262.26953125, 6700.57177734375, 7270.119140625, 7747.066650390625, 8109.29150390625, 8449.414306640625, 8898.2265625, 9225.5146484375, 9630.6689453125, 10159.443359375, 10529.865966796875, 10822.096923828125, 11106.101318359375, 11342.567626953125, 11584.412841796875, 11969.792236328125, 12246.706298828125, 12595.75439453125, 12826.018310546875, 13052.408935546875, 13325.99658203125, 13517.433837890625, 13711.820556640625, 14019.044921875, 14244.649658203125, 14479.777099609375, 14727.062744140625, 14909.215087890625, 15064.59814453125, 15237.263671875, 15410.953369140625, 15604.15771484375, 15837.955322265625, 16065.62255859375, 16241.02783203125, 16365.00341796875, 16571.48876953125, 16727.023681640625, 16806.36865234375, 16933.82861328125, 17100.252197265625, 17310.361328125, 17424.731689453125, 17545.23193359375, 17632.267333984375, 17726.348876953125, 17806.456298828125, 17896.553955078125, 17996.816650390625, 18154.62841796875, 18313.304443359375, 18407.881103515625, 18523.73681640625, 18598.811279296875, 18740.856201171875, 18866.1015625, 18932.1865234375, 19022.056640625, 19135.852294921875, 19223.337646484375, 19301.20849609375, 19406.017578125, 19523.098876953125, 19594.2998046875, 19631.6640625, 19698.3515625, 19781.87451171875, 19816.60400390625, 19996.078125, 20066.294189453125, 20108.075927734375, 20176.640869140625, 20243.049072265625, 20294.30126953125, 20358.0703125, 20446.534423828125, 20490.109130859375, 20543.31494140625, 20638.208740234375, 20673.724365234375, 20692.579833984375, 20755.868408203125, 20818.508056640625, 20904.514404296875, 20946.700927734375, 20974.8681640625, 21037.3134765625, 21072.834228515625, 21123.97265625, 21172.958984375, 21376.97900390625, 21428.192626953125]
stl_rest_loss= [21602.73876953125, 20482.873046875, 19652.841064453125, 18861.04150390625, 18159.6240234375, 17394.183837890625, 16847.85205078125, 16166.580078125, 15728.27783203125, 15158.73046875, 14681.782958984375, 14319.55810546875, 13979.435302734375, 13530.623046875, 13203.3349609375, 12798.1806640625, 12269.40625, 11898.983642578125, 11606.752685546875, 11322.748291015625, 11086.281982421875, 10844.436767578125, 10459.057373046875, 10182.143310546875, 9833.09521484375, 9602.831298828125, 9376.440673828125, 9102.85302734375, 8911.415771484375, 8717.029052734375, 8409.8046875, 8184.199951171875, 7949.072509765625, 7701.786865234375, 7519.634521484375, 7364.25146484375, 7191.5859375, 7017.896240234375, 6824.69189453125, 6590.894287109375, 6363.22705078125, 6187.82177734375, 6063.84619140625, 5857.36083984375, 5701.825927734375, 5622.48095703125, 5495.02099609375, 5328.597412109375, 5118.48828125, 5004.117919921875, 4883.61767578125, 4796.582275390625, 4702.500732421875, 4622.393310546875, 4532.295654296875, 4432.032958984375, 4274.22119140625, 4115.545166015625, 4020.968505859375, 3905.11279296875, 3830.038330078125, 3687.993408203125, 3562.748046875, 3496.6630859375, 3406.79296875, 3292.997314453125, 3205.511962890625, 3127.64111328125, 3022.83203125, 2905.750732421875, 2834.5498046875, 2797.185546875, 2730.498046875, 2646.97509765625, 2612.24560546875, 2432.771484375, 2362.555419921875, 2320.773681640625, 2252.208740234375, 2185.800537109375, 2134.54833984375, 2070.779296875, 1982.315185546875, 1938.740478515625, 1885.53466796875, 1790.640869140625, 1755.125244140625, 1736.269775390625, 1672.981201171875, 1610.341552734375, 1524.335205078125, 1482.148681640625, 1453.9814453125, 1391.5361328125, 1356.015380859375, 1304.876953125, 1255.890625, 1051.87060546875, 1000.656982421875]

# binary task LBW = 2; loss = loss1**loss2
mtl_sudden_change_loss =[1422.078857421875, 2705.20263671875, 3760.653076171875, 4724.090087890625, 5549.1396484375, 6306.50048828125, 6952.941162109375, 7668.564697265625, 8257.779052734375, 8780.878662109375, 9323.546142578125, 9822.046875, 10262.248291015625, 10738.503173828125, 11174.31201171875, 11597.800537109375, 12018.904541015625, 12391.83203125, 12752.767822265625, 13147.858642578125, 13563.33349609375, 13887.935791015625, 14266.859619140625, 14583.002197265625, 14897.89990234375, 15201.481689453125, 15500.6591796875, 15782.448486328125, 16066.044677734375, 16352.414306640625, 16671.259033203125, 16938.77294921875, 17220.492431640625, 17445.927978515625, 17667.04541015625, 17879.2978515625, 18091.106201171875, 18280.90283203125, 18485.4052734375, 18698.170166015625, 18886.540283203125, 19100.216064453125, 19268.97802734375, 19454.824462890625, 19617.482177734375, 19760.665771484375, 19907.271240234375, 20059.11474609375, 20209.754638671875, 20367.7177734375, 20505.61962890625, 20638.4716796875, 20757.639404296875, 20884.52880859375, 21012.2822265625, 21124.87548828125, 21245.31884765625, 21363.751708984375, 21471.86474609375, 21571.645263671875, 21675.588134765625, 21788.4033203125, 21877.611083984375, 21966.63427734375, 22054.563232421875, 22162.0537109375, 22252.2734375, 22335.419677734375, 22419.859130859375, 22491.39599609375, 22564.2158203125, 22643.06396484375, 22721.49609375, 22796.359130859375, 22863.427001953125, 22943.802978515625, 23014.046875, 23075.66845703125, 23137.110107421875, 23192.68017578125, 23247.529052734375, 23302.977783203125, 23367.352783203125, 23421.0029296875, 23480.318115234375, 23520.368408203125, 23570.168701171875, 23619.27978515625, 23662.57763671875, 23706.62548828125, 23737.6826171875, 23773.912353515625, 23809.595947265625, 23844.839599609375, 23880.604736328125, 23914.371337890625, 23948.3759765625, 23981.52587890625, 24011.666259765625]
mtl_rest_loss = [23015.2451171875, 21732.121337890625, 20676.6708984375, 19713.23388671875, 18888.184326171875, 18130.823486328125, 17484.3828125, 16768.75927734375, 16179.544921875, 15656.4453125, 15113.77783203125, 14615.277099609375, 14175.07568359375, 13698.82080078125, 13263.011962890625, 12839.5234375, 12418.41943359375, 12045.491943359375, 11684.55615234375, 11289.46533203125, 10873.990478515625, 10549.38818359375, 10170.46435546875, 9854.32177734375, 9539.424072265625, 9235.84228515625, 8936.664794921875, 8654.87548828125, 8371.279296875, 8084.90966796875, 7766.06494140625, 7498.551025390625, 7216.83154296875, 6991.39599609375, 6770.278564453125, 6558.026123046875, 6346.2177734375, 6156.421142578125, 5951.918701171875, 5739.15380859375, 5550.78369140625, 5337.10791015625, 5168.345947265625, 4982.49951171875, 4819.841796875, 4676.658203125, 4530.052734375, 4378.209228515625, 4227.5693359375, 4069.606201171875, 3931.704345703125, 3798.852294921875, 3679.6845703125, 3552.795166015625, 3425.041748046875, 3312.448486328125, 3192.005126953125, 3073.572265625, 2965.459228515625, 2865.6787109375, 2761.73583984375, 2648.920654296875, 2559.712890625, 2470.689697265625, 2382.7607421875, 2275.270263671875, 2185.050537109375, 2101.904296875, 2017.46484375, 1945.927978515625, 1873.108154296875, 1794.260009765625, 1715.827880859375, 1640.96484375, 1573.89697265625, 1493.52099609375, 1423.277099609375, 1361.655517578125, 1300.2138671875, 1244.643798828125, 1189.794921875, 1134.34619140625, 1069.97119140625, 1016.321044921875, 957.005859375, 916.95556640625, 867.1552734375, 818.044189453125, 774.746337890625, 730.698486328125, 699.641357421875, 663.41162109375, 627.72802734375, 592.484375, 556.71923828125, 522.95263671875, 488.947998046875, 455.798095703125, 425.65771484375]


mtl_total = [sum(x) for x in zip(mtl_sudden_change_loss, mtl_rest_loss)]
stl_total = [sum(x) for x in zip(stl_sudden_change_loss, stl_rest_loss)]


mtl_sudden_change_loss = [mtl_sudden_change_loss[i]/ss[i] for i in range(len(ss))]
mtl_rest_loss = [mtl_rest_loss[i]/(825-ss[i]) for i in range(len(ss))]

stl_sudden_change_loss = [stl_sudden_change_loss[i]/ss[i] for i in range(len(ss))]
stl_rest_loss = [stl_rest_loss[i]/(825-ss[i]) for i in range(len(ss))]

fig,ax = plt.subplots()
ax.plot(np.array(ss), mtl_sudden_change_loss, color="red", marker="o",label="MTL sudden")
ax.plot(np.array(ss), stl_sudden_change_loss, color="red", marker="v", label="STL sudden")
plt.legend(loc=1)
ax.set_xlabel("size",fontsize=14)
ax.set_ylabel("Avg MSE loss for sudden change points",color="red",fontsize=14)
ax2=ax.twinx()
ax2.plot(np.array(ss), mtl_rest_loss,color="blue",marker="o", label="MTL rest")
ax2.plot(np.array(ss), stl_rest_loss,color="blue",marker="v", label="STL rest")
ax2.set_ylabel("Avg MSE loss for the rest of the points",color="blue",fontsize=14)
plt.legend(loc=3)
plt.show()


h = plt.figure()

plt.plot(ss, mtl_total, label="MTL total loss")
plt.plot(ss, stl_total, label="STL total loss")

# plt.plot(np.array(x), np.array(mapelosses), label="train mape")
# plt.plot(np.array(x), test_mapes, label="test mape",color='green')

plt.xlabel("size")
plt.ylabel("total loss")
plt.legend()
plt.savefig('multiclass test loss.png')
plt.show()


